<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>REVERSI</title>
</head>
<body>
  <header>
    <h1>REVERSI</h1>
  </header>
  <main>
    <div id="app">
      <table>
        <tr v-for="(line, index) in board" :key="index">
          <td v-for="cell in line" :key="cell.index">
            <span class="cellState" :class="cellStateClass(cell.state)"></span>
          </td>
        </tr>
      </table>
      <div class="moves">
        <div v-for="(move, index) in moves" :key="index">
          <button @click="onClickPass" v-if="move === 'pass'">{{ move }}</button>
          <button @click="onClickMoveButton(move)" v-else>{{ move }}</button>
        </div>
      </div>
  </main>
</body>
</html>

<script>
  <?php echo "const boardFromPhp = JSON.parse('${boardJson}')" . PHP_EOL ?>

  const boardMatrix = (board) => {
    const matrix = {}
    for (index in board) {
      const group = 'y' + board[index].y
      if (!matrix[group]) {
        matrix[group] = []
      }
      matrix[group].push(board[index])
    }
    return matrix
  }

  const { createApp } = Vue

  createApp({
    data() {
      return {
        board: boardMatrix(boardFromPhp.board),
        moves: boardFromPhp.moves
      }
    },
    mounted() {
      this.updateBoard()
    },
    methods: {
      async updateBoard() {
        const board = await axios.get('/board')
        this.board = boardMatrix(board.data.board)
        this.moves = board.data.moves
      },
      cellStateClass(state) {
        switch(state) {
          case 'white':
            return 'cell-white'
          case 'black':
            return 'cell-black'
          default:
            return 'empty'
        }
      },
      onClickMoveButton(move) {
        const params = new URLSearchParams()
        params.append('index', move)
        axios.post('/move', params, {
          headers: {'Content-Type': 'application/x-www-form-urlencoded'}
        })
        .then(() => {
          this.updateBoard()
        })
      },
      onClickPass() {
        axios.post('/pass').then(() => this.updateBoard())
      }
    }
  }).mount('#app')
</script>

<style>
  table {
    border-spacing: 0;
    border-collapse: collapse;
    box-shadow: 1px 2px 0.4px 0.1px rgb(0 0 0 / 20%);
    border: 1px solid #999;
    margin: 10px auto;
  }
  table td {
    border: .2px solid #666;
    width: 25px;
    height: 25px;
    background-color: #00d202;
  }
  .cellState {
    margin: auto;
    display: block;
  }
  .cellState.cell-white {
    background-color: #fafafa;
    width: 20px;
    height: 20px;
    border-radius: 10px;
    border: 0.3px solid #333;
    box-shadow: 1px 2px 0.4px 0.1px rgb(0 0 0 / 20%);
  }
  .cellState.cell-black {
    background-color: #232323;
    width: 20px;
    height: 20px;
    border-radius: 10px;
    border: 0.3px solid #fff;
    box-shadow: 1px 2px 0.4px 0.1px rgb(0 0 0 / 20%);
  }

  .moves {
    margin: 0 auto;
    display: flex;
    justify-content: center;
  }
  .moves button {
    margin: 0 3px;
    background: #eee;
    color: #666;
    border: 0.3px solid #999;
    border-radius: 3px;
    padding: 3px 10px;
  }
</style>
